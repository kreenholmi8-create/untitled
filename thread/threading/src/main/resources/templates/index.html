<!-- src/main/resources/templates/index.html -->
<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Вакансии – демо</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        .page {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px 16px 48px;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 16px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            font-family: monospace;
            font-size: 13px;
            padding: 8px;
            box-sizing: border-box;
        }

        button {
            margin: 8px 8px 8px 0;
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: #2b7cff;
            color: #fff;
        }

        button.secondary {
            background: #666;
        }

        button:disabled {
            background: #ccc;
            cursor: default;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 16px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px 8px;
        }

        th {
            background: #f0f0f0;
        }

        .status {
            font-size: 13px;
            color: #555;
            margin-top: 8px;
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="card">
            <h2>Генерация URL для мок‑вакансий</h2>
            <p>Здесь можно сгенерировать 20 URL вида <code>/mock/vacancy/{source}/{id}</code> и отправить их на парсинг.
            </p>

            <textarea id="urlsTextarea"></textarea>

            <div>
                <button id="generateBtn" type="button">Сгенерировать 20 URL</button>
                <button id="sendBtn" type="button">Отправить на парсинг</button>
                <button id="sendBtnForce" type="button">Отправить на парсинг без шедулера</button>
            </div>
            <div class="status" id="parseStatus"></div>
        </div>

        <div class="card">
            <h2>Просмотр вакансий из H2 </h2>
            <div><a href="/h2-console">Ссылка на H2 консоль</a></div>

            <!-- Блок фильтров -->
            <div style="margin-top: 12px; margin-bottom: 8px;">
                <label>
                    Город:
                    <input id="filterCity" type="text" placeholder="Москва" style="margin-right: 8px;">
                </label>
                <label>
                    Компания:
                    <input id="filterCompany" type="text" placeholder="Яндекс">
                </label>
            </div>

            <div>
                <button id="loadVacanciesBtn" type="button" class="secondary">Загрузить вакансии</button>
            </div>
            <div class="status" id="vacancyStatus"></div>
            <div id="vacancyTableWrapper"></div>
        </div>
    </div>

    <script>
        // Список источников должен совпадать с VacancyConfig.SOURCES
        const SOURCES = ["hh.ru", "superjob.ru", "rabota.ru", "linkedin.com", "career.habr.com"];
        
        function generateUrlsClick(ev) {
            generateUrls();
        }

        function generateUrls(count = 20) {
            const urls = [];
            const origin = window.location.origin;
            for (let i = 0; i < count; i++) {
                const source = SOURCES[Math.floor(Math.random() * SOURCES.length)];
                const id = 1 + Math.floor(Math.random() * 100000);

                urls.push(`${origin}/mock/vacancy/${source}/${id}`);
            }
            document.getElementById('urlsTextarea').value = urls.join('\n');
        }

        async function sendToParse() {
            const textarea = document.getElementById('urlsTextarea');
            const statusEl = document.getElementById('parseStatus');
            const raw = textarea.value.trim();
            if (!raw) {
                statusEl.textContent = "Поле пустое, нечего отправлять.";
                return;
            }
            const urls = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            const body = { urls: urls };

            statusEl.textContent = "Отправка...";
            try {
                const resp = await fetch('/api/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const text = await resp.text();
                statusEl.textContent = `Ответ сервера: ${resp.status} ${resp.statusText} – ${text}`;
            } catch (e) {
                statusEl.textContent = "Ошибка при отправке: " + e.message;
            }
        }

        async function sendToParseForce() {
            const textarea = document.getElementById('urlsTextarea');
            const statusEl = document.getElementById('parseStatus');
            const raw = textarea.value.trim();
            if (!raw) {
                statusEl.textContent = "Поле пустое, нечего отправлять.";
                return;
            }
            const urls = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            const body = { urls: urls };

            statusEl.textContent = "Отправка...";
            try {
                const resp = await fetch('/api/parse/force', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const text = await resp.text();
                statusEl.textContent = `Ответ сервера: ${resp.status} ${resp.statusText} – ${text}`;
            } catch (e) {
                statusEl.textContent = "Ошибка при отправке: " + e.message;
            }
        }

        async function loadVacancies() {
            const statusEl = document.getElementById('vacancyStatus');
            const wrapper = document.getElementById('vacancyTableWrapper');
            const city = document.getElementById('filterCity').value.trim();
            const company = document.getElementById('filterCompany').value.trim();

            statusEl.textContent = "Загрузка...";
            wrapper.innerHTML = "";

            try {
                const params = new URLSearchParams();
                if (city) params.append('city', city);
                if (company) params.append('company', company);

                const query = params.toString();
                const url = query ? `/api/vacancies?${query}` : '/api/vacancies';

                const resp = await fetch(url);
                if (!resp.ok) {
                    statusEl.textContent = `Ошибка: ${resp.status} ${resp.statusText}`;
                    return;
                }
                const data = await resp.json();
                statusEl.textContent = `Загружено записей: ${data.length}`;

                if (!data.length) {
                    wrapper.textContent = "Нет данных.";
                    return;
                }

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['ID', 'Название', 'Компания', 'Город', 'Зарплата', 'Дата публикации'].forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                data.forEach(v => {
                    const tr = document.createElement('tr');
                    const cells = [
                        v.id,
                        v.title,
                        v.company,
                        v.city,
                        v.salary,
                        v.publishedAt
                    ];
                    cells.forEach(val => {
                        const td = document.createElement('td');
                        td.textContent = val !== null && val !== undefined ? val : '';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                wrapper.appendChild(table);
            } catch (e) {
                statusEl.textContent = "Ошибка при загрузке: " + e.message;
            }
        }

        document.getElementById('generateBtn').addEventListener('click', generateUrlsClick);
        document.getElementById('sendBtn').addEventListener('click', sendToParse);
        document.getElementById('sendBtnForce').addEventListener('click', sendToParseForce);
        document.getElementById('loadVacanciesBtn').addEventListener('click', loadVacancies);

        // при первом открытии сразу сгенерируем 20 URL
        generateUrls();
    </script>
</body>

</html>